title: 树链剖分
author: Chocola4ever
tags:
  - 模板
  - 树链剖分
categories:
  - 算法
date: 2021-03-29 17:55:00
---
```cpp
#include<bits/stdc++.h>
#define MAXN 10005
using namespace std;
int sz[MAXN],f[MAXN],dep[MAXN],head[MAXN];
struct{
    int nxt,to,val;
}e[MAXN];
void dfs1(int u){//一遍dfs求sz,dep,f(子树大小,深度,父亲) 
    sz[u]=1;
    for (int i=head[u];i;i=e[i].nxt){
        int v=e[i].to;
        if (!dep[v])
        {
            dep[v]=dep[u]+1;
            f[v]=u;
            dfs1(v);
            sz[u]+=sz[v];
            if (sz[v]>sz[son[u]])
                son[u]=v;
        }
    }
}
void dfs2(int u,int chain){//第二遍dfs求anc和p(u所在重链顶结点,树链剖分序) 
    p[u]=++cnt;
    anc[u]=chain;
    if (!son[u])
        return;
    dfs2(son[u],chain);
    for (int i=head[u];i;i=e[i].nxt){
        int v=e[i].to;
        if (dep[v]>dep[u]&&v!=son[u])
            dfs2(v,v);
    }
}
int lca(int u,int v){//树链剖分求lca最近公共祖先
    while (anc[u]!=anc[v]){
        if (dep[anc[u]]>dep[anc[v]])
            u=f[anc[u]];
        else
            v=f[anc[v]];
    }
  return dep[u]>dep[v]?v:u;
}
int main(){
    cnt=0;
    dfs1(1);
    dfs2(1,1);
} 
```